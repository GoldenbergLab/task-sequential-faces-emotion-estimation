
<!DOCTYPE html>
<html> 
  <head>
    <title>sequenccollective_emotion_estimation_task</title>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-call-function.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-slider-response_noButton.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="sequential_task_functions.js"></script>
    <script src="functions.js"></script>
    <script src="jquery-3.3.1.min.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body bgcolor="#AAAAAA"></body>
  <script>

  /* ************************************ */
  /* Set up jsPsych blocks - static */
  /* ************************************ */


  var taskNumber = 6; //must be mutiples of 5. The real trial number will have one extra due to attention check trial
  var attentionCheckInterval = 3; // there will be an attention check every this number of trials
  var practiceNumber = 3;
  var Face = {}; //create Face dictionary to (1)record fixation time, (2)make face sample and scale have the same person and valence in every trial
  Face.pos = [ ];  //(3)record data of 12 faces' data in face array
  Face.facePool = [ ];
  var facesPool = loadFacePool(51,150);
  var slideList = createSlideList (1,8);//list of instructions slides, which have index from 1 to 8

  var userList =jQuery.get('https://web.stanford.edu/~amitgold/categorization_task/previousUsersID.txt', function(data) {});

  /******************************************/
  /* Set up Instructions */
  /******************************************/

  var instructions = {
      type: "image-button-response",
      stimulus: getNextSlide,
      choices: ['Continue'],
      margin_vertical: '10px',
      data: {Name:'instructions'}
    };

  /******************************************/
  /* Start Experiment - trial by trial */
  /******************************************/
  
  var consent = {
    type:'external-html',
    url: "external_page.html",
    cont_btn: "start",
    check_fn: check_consent
  };

  var citizenship = {
    type: 'image-button-response',
    stimulus: '',
    choices: ['Yes','No'],
    prompt: "Are you an American citizen?",
    data: {Name:'citizenship'}
  };

  var checkCitizen = { //to check if participant is American citizen. If it's 'No', the experiment will be terminated
    timeline: [citizenship],
    loop_function: checkCitizen
  };

  var phone = {
    type: 'image-button-response',
    stimulus: '',
    choices: ['Phone','Computer'],
    prompt: "Are you using a mobile phone or computer to conduct the experiment?",
    data: {Name:'phone'}
  };

  var checkPhone = { //to check if participant is using phone. If it's 'No', the experiment will be terminated
    timeline: [phone],
    loop_function: checkPhone
  };

  var enter_id = {
    type: 'survey-text',
    questions: [{prompt: 'Please enter your mTurk id (this is important for your validation)'}],
    on_finish: function(data){
      Face.ID = JSON.parse(data.responses).Q0; //save id as global variable
      jsPsych.data.addProperties({participant_id: Face.ID});} //record participant id
  };

  var participant_id = { //to check if participants have entered ID (number/character, no punctuation allowed)
    timeline: [enter_id],
    loop_function: checkID,
    loop_function: checkUser
  };


  var fixationGetFace = { //getting new fixation time and face
      type: 'html-keyboard-response',
      stimulus: '<p style="font-size: 48px;">+</p>',
      trial_duration:  getTimeAndFace,  //random select fixation time
      data: {Name:'fixation'}
  };

  var fixation = { //only get new fixation time without changing face - in one series of face, there're different fixation time
      type: 'html-keyboard-response',
      stimulus: '<p style="font-size: 48px;">+</p>',
      trial_duration:  getFixationTime,  //random select fixation time
      data: {Name:'fixation'}
  };


  var face = {                //there is an array of randomly selected pictures//
        type: 'image-keyboard-response',
        stimulus:  getFaceSample,
        trial_duration: 500,  //display faces for 0.5 second
        choices: jsPsych.NO_KEYS,
        data: function(){Name:'singleFace',
       //add data of the single face to face pool
        Face.facePool.push(Face.singleFace)},
  };


  var response = {
        type: 'image-slider-response_noButton',
        stimulus: getScale,
        prompt: "<p>Estimate the average emotion of the faces you saw in the previous window </p>",
        step:1,
        max:50,
        start: 0,
        on_finish: function(){Face.facePool = [0]}, // empty face pool after each trial
        data: function(){
        return {
          Name: 'response',
          fixationTime: Face.fixationTime,
          // record face's identity
          faceIdentity: Face.personX,
          // record every face's index
          face_1:(Face.emotionX + Face.facePool[1]),   face_2:(Face.emotionX + Face.facePool[2]),
          face_3:(Face.emotionX + Face.facePool[3]),   face_4:(Face.emotionX + Face.facePool[4]),
          face_5:(Face.emotionX + Face.facePool[5]),   face_6:(Face.emotionX + Face.facePool[6]),
          face_7:(Face.emotionX + Face.facePool[7]),   face_8:(Face.emotionX + Face.facePool[8]),
          face_9:(Face.emotionX + Face.facePool[9]),   face_10:(Face.emotionX + Face.facePool[10]),
          face_11:(Face.emotionX + Face.facePool[11]), face_12:(Face.emotionX + Face.facePool[12])
        }}
      };

  var stimulus = { //image for attention check
    type: 'image-button-response',
    stimulus: getStim,
    choices: [],
    trial_duration : 5000,
    prompt: "",
    data: {Name:'stimuli'}
  };

  var attention = {
    on_start: saveData,
    type: 'survey-text',
    questions: [{prompt: 'Please describe, in your own words, the content of the image just displayed'}],
    on_finish: function(data){
      Face.description = JSON.parse(data.responses).Q0;
    } //save description
  };

  var checkAttention = { //to check if participant is American citizen. If it's 'No', the experiment will be terminated
    timeline: [attention],
    loop_function: checkAnswer
  };

  var connectSurvey = {
    type: 'image-button-response',
    stimulus: getNextSlide,
    choices: ['Begin Survey']
  };


  /* create experiment definition array */

  var collective_emotion_estimation = []; //display instructions

  //collective_emotion_estimation.push(consent);
  collective_emotion_estimation.push(checkCitizen,checkPhone);
  collective_emotion_estimation.push(participant_id);

  for (var i = 0; i < slideList.length-2; i++) {
     collective_emotion_estimation.push(instructions)}; 

  for (var i = 0; i < practiceNumber; i++) {     //practice trials
    faceNumber = getRandomInt(1,12);
    collective_emotion_estimation.push(fixationGetFace,checkAttention); 
    for (var t = 0; t < faceNumber; t++) {
      collective_emotion_estimation.push(fixation); 
      collective_emotion_estimation.push(face);}
    collective_emotion_estimation.push(response);
  };

  collective_emotion_estimation.push(instructions); //move on to real task


  for (var i = 0; i < taskNumber/attentionCheckInterval; i++) {

    for (var i = 0; i < taskNumber; i++) {
      faceNumber = getRandomInt(1,12);
      collective_emotion_estimation.push(fixationGetFace);  
      for (var t = 0; t < faceNumber; t++) {
        collective_emotion_estimation.push(fixation); 
        collective_emotion_estimation.push(face);}
      collective_emotion_estimation.push(response);
    };

    var k = 0;
    while (k < (attentionCheckInterval - 1)){
      collective_emotion_estimation.push(fixation,stimulus,response,facesSample,button);
      k ++;}
  }

  collective_emotion_estimation.push(connectSurvey);

  /* start the experiment */
  jsPsych.init({
  timeline: collective_emotion_estimation,
    on_finish: function(data){               //saveData
		var final_submit = function() {
             jsPsych.turk.submitToTurk({"completion_time": (new Date().getTime())});
          };
		  saveData("2019_first_pilot_amplification/" + Face.ID+ ".json",
     jsPsych.data.get().json(), final_submit, final_submit);
    jsPsych.data.get().localSave('csv',Face.ID+'.csv'); //save as csv file with id as file name
    window.location = "https://stanforduniversity.qualtrics.com/jfe/form/SV_cBULlVQd3dVp3q5"
    }

  })

  </script>
  </html>
